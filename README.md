# 초개인화 DA 자동 생성 AI 에이전트

> 사용자 클릭 광고에서 시각적 선호 스타일을 추출하고, 신규 제품에 맞는 광고 이미지를 자동으로 생성·검증하는 멀티 에이전트 파이프라인

---

## 주제

**광고 소재 제작 자동화 — 사용자 선호 기반 초개인화 DA(Display Ad) 생성**

디지털 광고 소재를 사람이 직접 기획·제작하지 않고, AI 에이전트가 **사용자 행동 데이터 → 스타일 추출 → 설계 → 이미지 생성 → 자동 검수**까지 전 과정을 처리하는 end-to-end 시스템입니다.

---

## 문제 정의

### 1. 개인화 소재 제작의 한계
광고 효율은 소재의 개인화 수준에 직결되지만, 기존 DA 제작 방식은 디자이너가 수작업으로 제작하기 때문에 사용자별 맞춤 소재 제공이 현실적으로 불가능합니다.

### 2. 클릭 데이터를 소재에 활용하지 못함
사용자가 어떤 광고를 클릭했는지는 로그로 남지만, **"왜 클릭했는가(색감 선호, 카피 톤, 레이아웃 취향)"** 를 자동으로 해석해 신규 소재에 반영하는 시스템이 없었습니다.

### 3. 가이드라인 검수 부재
생성된 광고가 브랜드 가이드라인(금지어, 필수 요소, 매체 규격)을 위반해도 검수자가 수동으로 확인하기 전까지 발견이 어렵습니다.

---

## 문제 해결

### 아키텍처 — 4단계 멀티 에이전트 파이프라인

```
[사용자 클릭 광고]  →  Stage 1 (추출)  →  Stage 2 (설계)  →  Stage 3 (생성)  →  Stage 4 (평가)
                                                                                        │
                                                         PASS ◄──────────────────────┘
                                                           │         FAIL: 피드백 포함 Stage 2 재진입
                                                      최종 광고 반환
```

| Stage | 역할 | 핵심 설계 |
|---|---|---|
| **Stage 1 Extractor** | 클릭 광고 이미지 분석 → Style DNA 추출 | 이미지 스타일 / 레이아웃 / 카피 톤 3개 축을 `asyncio.gather()`로 **병렬** 호출 |
| **Stage 2 Architect** | Style DNA + 제품 정보 → 생성 설계도(Blueprint) 작성 | 한국 감성 키워드 → FLUX.1 영문 프롬프트 자동 변환, 캔버스 비율에 따른 레이아웃 좌표 자동 산출 |
| **Stage 3 Generator** | AI 배경 이미지 생성 + 제품·텍스트·로고 합성 | FLUX.1 txt2img로 배경 생성, `rembg` 배경 제거 후 Pillow로 실제 제품 사진 합성 |
| **Stage 4 Evaluator** | 브랜드/매체 가이드라인 자동 검수 | Vision 분석(시각 요소) + 카피 텍스트 직접 검사(금지어·법적 문구)의 이중 검증 |

### 주요 기술적 의사결정

**① 비용 최적화 모델 배분**
```
Stage 1, 4  →  gpt-4o-mini   : 분류·평가는 경량 모델로 충분, 3회 병렬 호출도 저비용
Stage 2     →  gpt-4o        : 카피 품질 + 프롬프트 엔지니어링이 전체 광고 성과 결정
Stage 3     →  FLUX.1 (fal.ai): 로컬 GPU 없이 클라우드 API로 고품질 이미지 생성
```

**② 텍스트 이중 검증으로 OCR 오류 제거**
생성된 이미지에서 한글을 OCR로 재인식하는 대신, Stage 2에서 생성한 카피 텍스트 원본을 Stage 4에 직접 전달합니다. 소형·장식 폰트의 OCR 오인식 리스크를 제거하고 검수 정확도를 높입니다.

**③ 어절 단위 텍스트 줄바꿈**
Pillow의 기본 글자 단위 wrapping은 한국어에서 어절 중간 분리("가격" → "가" / "금")를 발생시킵니다. 띄어쓰기 기준 어절 단위로 먼저 줄바꿈을 시도하고, 단일 어절이 max_width를 초과할 때만 글자 단위로 강제 분할하는 방식으로 해결했습니다.

**④ 평가 루프로 품질 보장**
한 번 생성으로 끝나지 않고, 가이드라인 미달 시 이전 평가의 이슈와 수정 방향을 컨텍스트에 포함해 재설계 → 재생성을 최대 N회 자동 반복합니다.

### 기술 스택

| 분류 | 기술 |
|---|---|
| **언어 / 환경** | Python 3.12, uv |
| **비동기 처리** | asyncio, httpx |
| **LLM (추출·설계·평가)** | GPT-4o, GPT-4o-mini (OpenAI API) |
| **이미지 생성** | FLUX.1 [dev] via fal.ai |
| **이미지 후처리** | Pillow, rembg (배경 제거) |
| **데이터 모델** | Pydantic v2 |
| **설정 관리** | pydantic-settings, python-dotenv |

---

## 결과

### 자동화 달성 범위

| 기존 프로세스 | 자동화 후 |
|---|---|
| 디자이너가 수작업으로 레이아웃 기획 | Style DNA 기반 레이아웃 좌표 자동 산출 |
| 카피라이터가 톤앤매너 직접 작성 | 사용자 클릭 광고의 카피 스타일 추출 → 신규 제품 카피 자동 생성 |
| 이미지 배경 촬영 또는 수작업 제작 | FLUX.1 프롬프트 자동 생성 → 제품 카테고리 맞춤 배경 자동 생성 |
| 검수자가 가이드라인 항목 수동 확인 | Vision + 텍스트 이중 검증으로 자동 채점 및 피드백 생성 |
| 미달 시 처음부터 재작업 | 평가 피드백 포함 자동 재설계 루프 |

### 산출물 예시

- 1000×1000 정방형, 1660×260 가로형 배너 등 멀티 포맷 자동 대응
- 클릭 광고 1장 입력 → 신규 제품 광고 이미지 1장 + 가이드라인 평가 리포트 자동 출력
- 가이드라인 미통과 시 최대 3회 자동 재생성, 최종 점수 기준 최고 결과물 반환

---

## 프로젝트 구조

```
src/da_agent/
├── pipeline.py              # 전체 파이프라인 오케스트레이터
├── config.py                # 환경변수·모델 설정 (pydantic-settings)
├── agents/
│   ├── extractor/           # Stage 1: 이미지 스타일·레이아웃·카피 병렬 추출
│   ├── architect.py         # Stage 2: Blueprint 생성 (카피 + 이미지 프롬프트 + 레이아웃)
│   ├── generator.py         # Stage 3: FLUX.1 생성 + Pillow 합성
│   └── evaluator.py         # Stage 4: 가이드라인 자동 검수
├── models/                  # Pydantic 데이터 모델 (Stage 간 타입 보장)
└── utils/
    ├── image_utils.py       # 한글 텍스트 렌더링, 배경 제거, 이미지 합성
    └── prompt_templates/    # LLM 시스템 프롬프트 (한국 감성 → 영문 변환 규칙 포함)
```

## 빠른 시작

```bash
git clone https://github.com/KJooolee/Hyper-Personalized-DA-Auto-Generation-Agent.git
cd Hyper-Personalized-DA-Auto-Generation-Agent
uv sync
cp .env.example .env   # API 키 입력 (OpenAI, fal.ai)
uv run python -m da_agent
```

---

*MIT License*
